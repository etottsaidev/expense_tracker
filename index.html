<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Expense">
  <meta name="theme-color" content="#000000">
  <title>Expense Tracker</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #000;
      color: #fff;
      min-height: 100vh;
      overscroll-behavior: none;
      -webkit-user-select: none;
      user-select: none;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }

    input,
    select {
      -webkit-user-select: text;
      user-select: text;
    }

    ::-webkit-scrollbar {
      display: none;
    }

    .status-bar {
      height: 48px;
      background: linear-gradient(to bottom, #111, transparent);
    }

    .header {
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-title {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(to right, #fbbf24, #f97316);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-subtitle {
      color: #6b7280;
      font-size: 14px;
    }

    .add-btn {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #f59e0b, #ea580c);
      border: none;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(249, 115, 22, 0.3);
    }

    .add-btn svg {
      width: 24px;
      height: 24px;
      stroke: #000;
      fill: none;
      stroke-width: 2;
    }

    .main {
      padding: 0 24px 140px;
    }

    .hidden {
      display: none !important;
    }

    .month-selector {
      overflow-x: auto;
      padding-bottom: 8px;
      margin: 0 -24px;
      padding-left: 24px;
      padding-right: 24px;
    }

    .month-list {
      display: flex;
      gap: 8px;
      min-width: max-content;
    }

    .month-btn {
      padding: 12px 16px;
      border-radius: 16px;
      border: 1px solid #374151;
      background: rgba(17, 24, 39, 0.5);
      color: #6b7280;
      font-size: 14px;
      min-width: 70px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .month-btn.active {
      background: linear-gradient(135deg, #f59e0b, #ea580c);
      color: #000;
      font-weight: 700;
      border-color: transparent;
    }

    .month-btn.has-data {
      background: #1f2937;
      color: #fff;
      border-color: #374151;
    }

    .month-btn-sub {
      font-size: 11px;
      margin-top: 4px;
      opacity: 0.7;
    }

    .summary {
      text-align: center;
      padding: 24px 0;
    }

    .summary-label {
      color: #6b7280;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 8px;
    }

    .summary-amount {
      font-size: 48px;
      font-weight: 700;
      background: linear-gradient(to right, #fbbf24, #f97316, #f43f5e);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .expense-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .expense-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: rgba(17, 24, 39, 0.5);
      border: 1px solid #1f2937;
      border-radius: 16px;
    }

    .expense-item-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .expense-item-name {
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .delete-btn {
      width: 32px;
      height: 32px;
      background: transparent;
      border: none;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
    }

    .delete-btn svg {
      width: 16px;
      height: 16px;
      stroke: #f87171;
      fill: none;
      stroke-width: 2;
    }

    .delete-btn:active {
      background: rgba(239, 68, 68, 0.2);
    }

    .expense-input {
      width: 100px;
      text-align: right;
      background: transparent;
      border: none;
      color: #fbbf24;
      font-family: ui-monospace, monospace;
      font-size: 18px;
      padding: 4px 8px;
      border-radius: 8px;
    }

    .expense-input:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.5);
    }

    .expense-checkbox {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid #4b5563;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      cursor: pointer;
      transition: all 0.3s;
      flex-shrink: 0;
    }

    .expense-checkbox.checked {
      background: #10b981;
      border-color: transparent;
    }

    .expense-checkbox svg {
      width: 14px;
      height: 14px;
      stroke: #000;
      stroke-width: 3;
      fill: none;
    }

    .expense-item.paid {
      opacity: 0.6;
      background: rgba(17, 24, 39, 0.3);
    }

    .expense-item.paid .expense-item-name {
      text-decoration: line-through;
      color: #9ca3af;
    }

    .expense-item.paid .expense-input {
      text-decoration: line-through;
      color: #9ca3af;
    }

    .add-item-btn {
      width: 100%;
      padding: 16px;
      border: 2px dashed #374151;
      border-radius: 16px;
      background: transparent;
      color: #6b7280;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 12px;
      font-size: 16px;
    }

    .add-item-btn:active {
      color: #fbbf24;
      border-color: rgba(245, 158, 11, 0.5);
    }

    .add-item-btn svg {
      width: 20px;
      height: 20px;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
    }

    .check-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid #1f2937;
      background: rgba(17, 24, 39, 0.5);
      margin-bottom: 8px;
    }

    .check-item.checked {
      background: linear-gradient(to right, rgba(6, 78, 59, 0.4), rgba(6, 78, 59, 0.2));
      border-color: rgba(4, 120, 87, 0.3);
    }

    .check-item-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .checkbox {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid #4b5563;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      flex-shrink: 0;
    }

    .checkbox.checked {
      background: linear-gradient(135deg, #fbbf24, #f97316);
      border-color: transparent;
    }

    .checkbox svg {
      width: 16px;
      height: 16px;
      stroke: #000;
      stroke-width: 3;
      fill: none;
    }

    .check-item-text {
      font-size: 16px;
      color: #fff;
    }

    .check-item.checked .check-item-text {
      color: #9ca3af;
      text-decoration: line-through;
    }

    .check-item-amount {
      font-family: ui-monospace, monospace;
      font-size: 18px;
      color: #fbbf24;
    }

    .check-item.checked .check-item-amount {
      color: #34d399;
    }

    .installment-section {
      margin-bottom: 32px;
    }

    .installment-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .installment-info {
      flex: 1;
    }

    .installment-title {
      font-size: 20px;
      font-weight: 700;
      color: #fff;
    }

    .installment-subtitle {
      color: #fbbf24;
      font-family: ui-monospace, monospace;
      font-size: 14px;
    }

    .installment-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .progress-box {
      text-align: center;
    }

    .progress-text {
      font-size: 24px;
      font-weight: 700;
      color: #34d399;
    }

    .progress-label {
      color: #6b7280;
      font-size: 12px;
    }

    .summary-card {
      background: linear-gradient(135deg, #111827, #030712);
      border-radius: 24px;
      padding: 24px;
      border: 1px solid #1f2937;
      margin-bottom: 16px;
    }

    .summary-card-label {
      color: #6b7280;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 8px;
    }

    .summary-card-amount {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(to right, #fbbf24, #f97316);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .summary-card-amount.green {
      background: linear-gradient(to right, #34d399, #14b8a6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .summary-card-sub {
      color: #4b5563;
      font-size: 14px;
      margin-top: 8px;
    }

    .card-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }

    .card-grid .summary-card {
      margin-bottom: 0;
    }

    .trip-header {
      text-align: center;
      padding: 16px 0;
    }

    .trip-title {
      font-size: 24px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 8px;
    }

    .trip-date {
      color: #6b7280;
    }

    .trip-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .trip-label {
      color: #9ca3af;
    }

    .trip-value {
      color: #fff;
    }

    .trip-badge {
      padding: 4px 12px;
      border-radius: 9999px;
      font-size: 14px;
    }

    .trip-badge.pending {
      background: rgba(245, 158, 11, 0.2);
      color: #fbbf24;
    }

    .trip-badge.done {
      background: rgba(52, 211, 153, 0.2);
      color: #34d399;
    }

    .trip-divider {
      border-top: 1px solid #1f2937;
      margin-top: 16px;
      padding-top: 16px;
    }

    .trip-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .trip-total-label {
      color: #9ca3af;
    }

    .trip-total-amount {
      font-size: 24px;
      font-weight: 700;
      color: #fbbf24;
    }

    .card-item {
      padding: 16px;
      background: rgba(17, 24, 39, 0.5);
      border: 1px solid #1f2937;
      border-radius: 16px;
      margin-bottom: 12px;
    }

    .card-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .card-item-name {
      color: #fff;
      font-weight: 500;
    }

    .card-item-amount {
      color: #fbbf24;
      font-family: ui-monospace, monospace;
      font-weight: 700;
    }

    .card-item-detail {
      color: #6b7280;
      font-size: 14px;
      font-family: ui-monospace, monospace;
    }

    .card-section {
      background: linear-gradient(135deg, #111827, #0a0a0a);
      border-radius: 24px;
      border: 1px solid #1f2937;
      margin-bottom: 16px;
      overflow: hidden;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #1f2937;
    }

    .card-header-left {
      flex: 1;
    }

    .card-title {
      font-size: 20px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 4px;
    }

    .card-subtitle {
      color: #6b7280;
      font-size: 14px;
    }

    .card-header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .card-header-total {
      font-size: 24px;
      font-weight: 700;
      color: #fbbf24;
    }

    .card-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.5);
    }

    .card-row:last-of-type {
      border-bottom: none;
    }

    .card-row-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .card-row-date {
      width: 44px;
      height: 44px;
      background: #f59e0b;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .card-row-date.empty {
      background: transparent;
    }

    .date-label {
      font-size: 10px;
      color: #000;
      font-weight: 500;
    }

    .date-num {
      font-size: 18px;
      color: #000;
      font-weight: 700;
      line-height: 1;
    }

    .card-row-name {
      color: #fff;
      font-size: 16px;
    }

    .card-row-note {
      color: #6b7280;
      font-size: 12px;
      display: block;
    }

    .card-row-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-input {
      width: 120px;
      text-align: right;
      background: transparent;
      border: none;
      color: #fbbf24;
      font-family: ui-monospace, monospace;
      font-size: 18px;
      padding: 4px 8px;
    }

    .card-input:focus {
      outline: none;
    }

    .card-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
    }

    .card-total-label {
      color: #9ca3af;
      font-size: 14px;
    }

    .card-total-amount {
      font-size: 24px;
      font-weight: 700;
      color: #fbbf24;
    }

    .delete-btn.small {
      width: 28px;
      height: 28px;
    }

    .delete-btn.small svg {
      width: 14px;
      height: 14px;
    }

    .add-item-btn.small {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 0;
      background: transparent;
      color: #fbbf24;
      font-size: 14px;
      border-top: 1px solid #1f2937;
      margin-top: 0;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, #000, rgba(3, 7, 18, 0.95), transparent);
      padding: 32px 16px 32px;
    }

    .nav-container {
      display: flex;
      justify-content: space-around;
      align-items: flex-end;
      max-width: 512px;
      margin: 0 auto;
      background: rgba(17, 24, 39, 0.9);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 24px;
      border: 1px solid #1f2937;
    }

    .nav-btn {
      flex: 1;
      padding: 16px 8px;
      text-align: center;
      background: transparent;
      border: none;
      cursor: pointer;
      position: relative;
      transition: all 0.3s;
      color: #6b7280;
    }

    .nav-btn.active {
      color: #fbbf24;
    }

    .nav-icon {
      font-size: 24px;
      margin-bottom: 4px;
    }

    .nav-label {
      font-size: 12px;
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .nav-indicator {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 48px;
      height: 4px;
      background: linear-gradient(to right, #f59e0b, #f97316);
      border-radius: 9999px;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      z-index: 50;
    }

    .modal-overlay.center {
      align-items: center;
      padding: 24px;
    }

    .modal {
      background: #111827;
      border-radius: 24px 24px 0 0;
      width: 100%;
      max-width: 512px;
      padding: 24px 24px 40px;
      border-top: 1px solid #1f2937;
    }

    .modal.center {
      border-radius: 24px;
      padding: 24px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: #fff;
    }

    .modal-close {
      width: 40px;
      height: 40px;
      background: #1f2937;
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .modal-close svg {
      width: 20px;
      height: 20px;
      stroke: #9ca3af;
      fill: none;
      stroke-width: 2;
    }

    .modal-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .modal-option {
      padding: 24px;
      background: #1f2937;
      border: none;
      border-radius: 16px;
      text-align: center;
      cursor: pointer;
    }

    .modal-option:active {
      background: #374151;
    }

    .modal-option-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .modal-option-text {
      color: #fff;
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      color: #9ca3af;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 16px;
      background: #1f2937;
      border: none;
      border-radius: 16px;
      color: #fff;
      font-size: 16px;
    }

    .form-input:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.5);
    }

    .form-hint {
      color: #6b7280;
      font-size: 14px;
      margin-top: 8px;
    }

    .form-submit {
      width: 100%;
      padding: 16px;
      background: linear-gradient(to right, #f59e0b, #ea580c);
      border: none;
      border-radius: 16px;
      color: #000;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 16px;
    }

    .form-submit:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .confirm-text {
      color: #9ca3af;
      margin-bottom: 24px;
      font-size: 16px;
    }

    .confirm-buttons {
      display: flex;
      gap: 12px;
    }

    .confirm-btn {
      flex: 1;
      padding: 16px;
      border: none;
      border-radius: 16px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
    }

    .confirm-btn.cancel {
      background: #1f2937;
      color: #fff;
    }

    .confirm-btn.delete {
      background: #dc2626;
      color: #fff;
    }

    .quick-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .quick-tag {
      padding: 8px 16px;
      background: #1f2937;
      border: 1px solid #374151;
      border-radius: 20px;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
    }

    .quick-tag:active {
      background: #374151;
    }

    .quick-tag.selected {
      background: #f59e0b;
      color: #000;
      border-color: #f59e0b;
    }

    .form-input-with-icon {
      position: relative;
    }

    .form-input-with-icon .form-input {
      padding-left: 32px;
    }

    .form-input-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: #fbbf24;
      font-size: 18px;
    }

    /* Progress Bar */
    .budget-bar-container {
      height: 8px;
      background: #374151;
      border-radius: 4px;
      margin: 12px 0;
      overflow: hidden;
      position: relative;
    }

    .budget-bar-fill {
      height: 100%;
      background: #10b981;
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .budget-bar-fill.warning {
      background: #f59e0b;
    }

    .budget-bar-fill.danger {
      background: #ef4444;
    }

    .budget-info {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    /* Donut Chart */
    .chart-container {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 24px 0;
      position: relative;
    }

    .donut-chart {
      transform: rotate(-90deg);
    }

    .donut-segment {
      fill: transparent;
      stroke-width: 20;
      stroke-linecap: round;
      transition: stroke-dasharray 0.5s ease;
    }

    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin-bottom: 24px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #9ca3af;
    }

    .legend-color {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .chart-center-text {
      position: absolute;
      text-align: center;
    }

    .chart-total {
      .chart-label {
        font-size: 12px;
        color: #6b7280;
      }
    }

    /* Salary & Balance */
    .summary-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }

    .summary-card {
      background: #374151;
      padding: 12px;
      border-radius: 12px;
      text-align: center;
    }

    .summary-label {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .summary-value {
      font-size: 18px;
      font-weight: 600;
      color: #fff;
    }

    .summary-value.income {
      color: #10b981;
    }

    .summary-value.expense {
      color: #ef4444;
    }

    .balance-card {
      background: #1f2937;
      padding: 16px;
      border-radius: 16px;
      text-align: center;
      margin-bottom: 24px;
      border: 1px solid #374151;
    }

    .balance-label {
      font-size: 14px;
      color: #9ca3af;
      margin-bottom: 8px;
    }

    .balance-value {
      font-size: 32px;
      font-weight: 700;
      color: #fff;
    }

    .balance-value.positive {
      color: #10b981;
    }

    .balance-value.negative {
      color: #ef4444;
    }

    .salary-input-group {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .salary-edit-btn {
      background: none;
      border: none;
      color: #6b7280;
      cursor: pointer;
      padding: 4px;
    }
  </style>
</head>

<body>
  <div class="status-bar"></div>

  <header class="header">
    <div>
      <h1 class="header-title">Expense Tracker</h1>
      <p class="header-subtitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
    </div>
    <button class="add-btn" id="headerAddBtn">
      <svg viewBox="0 0 24 24">
        <path d="M12 4v16m8-8H4" />
      </svg>
    </button>
  </header>

  <main class="main">
    <!-- Monthly Tab -->
    <div id="monthlyTab">
      <div class="month-selector">
        <div class="month-list" id="monthList"></div>
      </div>
      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</div>
          <div class="salary-input-group">
            <div class="summary-value income" id="monthlyIncome">‡∏ø0</div>
            <button class="salary-edit-btn" id="editSalaryBtn">
              <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
              </svg>
            </button>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div>
          <div class="summary-value expense" id="monthlyTotal">‡∏ø0</div>
        </div>
      </div>

      <div class="balance-card">
        <div class="balance-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
        <div class="balance-value" id="monthlyBalance">‡∏ø0</div>
      </div>
      <div class="expense-list" id="expenseList"></div>
      <button class="add-item-btn" id="addExpenseBtn">
        <svg viewBox="0 0 24 24">
          <path d="M12 4v16m8-8H4" />
        </svg>
        ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      </button>
    </div>

    <!-- Installments Tab -->
    <div id="installmentsTab" class="hidden"></div>

    <!-- Trip Tab -->
    <div id="tripTab" class="hidden"></div>

    <!-- Cards Tab -->
    <div id="cardsTab" class="hidden"></div>
  </main>

  <nav class="bottom-nav">
    <div class="nav-container">
      <button class="nav-btn active" data-tab="monthly">
        <div class="nav-icon">üìä</div>
        <div class="nav-label">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
        <div class="nav-indicator"></div>
      </button>
      <button class="nav-btn" data-tab="installments">
        <div class="nav-icon">üìÖ</div>
        <div class="nav-label">‡∏ú‡πà‡∏≠‡∏ô</div>
      </button>
      <button class="nav-btn" data-tab="trip">
        <div class="nav-icon">‚úàÔ∏è</div>
        <div class="nav-label">‡∏ó‡∏£‡∏¥‡∏õ</div>
      </button>
      <button class="nav-btn" data-tab="cards">
        <div class="nav-icon">üí≥</div>
        <div class="nav-label">‡∏ö‡∏±‡∏ï‡∏£</div>
      </button>
    </div>
  </nav>

  <!-- Add Modal -->
  <div class="modal-overlay hidden" id="addModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</h3>
        <button class="modal-close" id="closeModal">
          <svg viewBox="0 0 24 24">
            <path d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div id="modalContent"></div>
    </div>
  </div>

  <!-- Delete Confirm Modal -->
  <div class="modal-overlay center hidden" id="deleteModal">
    <div class="modal center">
      <h3 class="modal-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
      <p class="confirm-text" id="deleteText">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?</p>
      <div class="confirm-buttons">
        <button class="confirm-btn cancel" id="cancelDelete">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="confirm-btn delete" id="confirmDelete">‡∏•‡∏ö</button>
      </div>
    </div>
  </div>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('SW registered'))
          .catch(err => console.log('SW registration failed:', err));
      });
    }
  </script>
  <script>
    // Data
    const MONTHS = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
    const CATEGORIES = {
      'food': { name: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£', color: '#f59e0b' },
      'travel': { name: '‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á', color: '#3b82f6' },
      'shopping': { name: '‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á', color: '#ec4899' },
      'bills': { name: '‡∏ö‡∏¥‡∏•/‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ', color: '#10b981' },
      'other': { name: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ', color: '#6b7280' }
    };

    const defaultItems = [
      { id: 1, name: 'K-PLUS', amount: 0 },
      { id: 2, name: 'SCB-SPC', amount: 0 },
      { id: 3, name: 'SCB-UP2', amount: 0 },
      { id: 4, name: 'Tiktok', amount: 0 },
      { id: 5, name: 'Shopee', amount: 0 },
      { id: 6, name: 'Krungsri-Auto (‡∏ú‡πà‡∏≠‡∏ô‡∏£‡∏ñ)', amount: 0 },
      { id: 7, name: 'NT-Net (‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï)', amount: 0 },
      { id: 8, name: 'UOB-WORLD (‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï)', amount: 0 },
      { id: 9, name: 'UOB-CLASH PLUSH (‡∏ú‡πà‡∏≠‡∏ô)', amount: 0 },
      { id: 10, name: 'Spotify', amount: 0 }
    ];

    function createInitialData() {
      const monthlyExpenses = {};
      MONTHS.forEach((m, i) => {
        monthlyExpenses[i] = { name: m, items: JSON.parse(JSON.stringify(defaultItems)) };
      });
      // Pre-fill November
      monthlyExpenses[10].items = [
        { id: 1, name: 'K-PLUS', amount: 0 },
        { id: 2, name: 'SCB-SPC', amount: 0 },
        { id: 3, name: 'SCB-UP2', amount: 664.60 },
        { id: 4, name: 'Tiktok', amount: 0 },
        { id: 5, name: 'Shopee', amount: 0 },
        { id: 6, name: 'Krungsri-Auto (‡∏ú‡πà‡∏≠‡∏ô‡∏£‡∏ñ)', amount: 6385.00 },
        { id: 7, name: 'NT-Net (‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï)', amount: 319.93 },
        { id: 8, name: 'UOB-WORLD (‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï)', amount: 1626 },
        { id: 9, name: 'UOB-CLASH PLUSH (‡∏ú‡πà‡∏≠‡∏ô)', amount: 1291.67 },
        { id: 10, name: 'Spotify', amount: 41.5 },
        { id: 11, name: 'Youtube', amount: 99 },
        { id: 12, name: 'Claude Code', amount: 699 }
      ];
      return {
        monthlyExpenses,
        installments: [
          {
            id: 'jp-ticket', name: '‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡∏±‡πã‡∏ß JP', monthlyAmount: 2164, payments: [
              { month: '‡∏ï.‡∏Ñ.', paid: true }, { month: '‡∏û.‡∏¢.', paid: false }, { month: '‡∏ò.‡∏Ñ.', paid: false },
              { month: '‡∏°.‡∏Ñ.', paid: false }, { month: '‡∏Å.‡∏û.', paid: false }, { month: '‡∏°‡∏µ.‡∏Ñ.', paid: false }
            ]
          },
          {
            id: 'kbank-loan', name: '‡∏Å‡∏π‡πâ‡πÄ‡∏á‡∏¥‡∏ô KBANK 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', monthlyAmount: 857.83, payments: [
              { month: '‡∏Å.‡∏Ñ.', paid: true }, { month: '‡∏™.‡∏Ñ.', paid: true }, { month: '‡∏Å.‡∏¢.', paid: true },
              { month: '‡∏ï.‡∏Ñ.', paid: true }, { month: '‡∏û.‡∏¢.', paid: false }, { month: '‡∏ò.‡∏Ñ.', paid: false }
            ]
          }
        ],
        trips: [
          {
            id: 'japan-69', name: '‡∏ó‡∏£‡∏¥‡∏õ‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô', date: '‡∏°.‡∏Ñ. 69', items: [
              { id: 1, name: '‡∏ï‡∏±‡πã‡∏ß‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏¥‡∏ô', amount: 12982 },
              { id: 2, name: '‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å (‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô)', amount: 4868.53 },
              { id: 3, name: '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á', amount: 0, note: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ã‡∏∑‡πâ‡∏≠' },
              { id: 4, name: 'eSIM', amount: 350, note: 'Vacay' }
            ]
          }
        ],
        cards: [
          {
            id: 'kbank', name: 'KBANK', month: '‡∏û.‡∏¢.', items: [
              { id: 1, name: '7-Eleven', amount: 99, date: 27 },
              { id: 2, name: '‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡πà‡∏≤', amount: 857.83 },
              { id: 3, name: '‡πÄ‡∏ô‡πá‡∏ï‡∏ó‡∏£‡∏π', amount: 555.33 }
            ]
          }
        ]
      };
    }

    // Load or init data
    let data;
    try {
      const saved = localStorage.getItem('expenseDataV5');
      data = saved ? JSON.parse(saved) : createInitialData();
      if (!data.monthlyExpenses) data = createInitialData();
      // Migrate old data
      if (!data.trips) data.trips = createInitialData().trips;
      if (!data.cards) data.cards = createInitialData().cards;
    } catch (e) { data = createInitialData(); }

    let currentTab = 'monthly';
    let selectedMonth = 10;
    let deleteTarget = null;

    function saveData() {
      try {
        localStorage.setItem('expenseDataV5', JSON.stringify(data));
        return true;
      } catch (e) {
        alert('‡πÄ‡∏°‡∏°‡πÄ‡∏ï‡πá‡∏°! ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏ö‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏á');
        console.error('Save failed:', e);
        return false;
      }
    }

    function formatNumber(num) {
      if (!num || num === 0) return '-';
      return num.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function getMonthTotal(monthIndex) {
      const items = data.monthlyExpenses[monthIndex]?.items || [];
      return items.reduce((sum, item) => sum + (item.amount || 0), 0);
    }

    function formatThaiDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      const month = MONTHS[date.getMonth()];
      const year = date.getFullYear() + 543;
      return `${month} ${year.toString().slice(-2)}`;
    }

    // Render functions
    function renderMonthList() {
      const container = document.getElementById('monthList');
      container.innerHTML = MONTHS.map((month, index) => {
        const total = getMonthTotal(index);
        let cls = 'month-btn';
        if (index === selectedMonth) cls += ' active';
        else if (total > 0) cls += ' has-data';
        return `<button class="${cls}" data-month="${index}">
          <div>${month}</div>
          ${total > 0 && index !== selectedMonth ? `<div class="month-btn-sub">${(total / 1000).toFixed(1)}k</div>` : ''}
        </button>`;
      }).join('');

      container.querySelectorAll('.month-btn').forEach(btn => {
        btn.onclick = () => {
          selectedMonth = parseInt(btn.dataset.month);
          renderMonthlyTab();
        };
      });
    }

    function renderExpenseList() {
      const container = document.getElementById('expenseList');
      const items = data.monthlyExpenses[selectedMonth]?.items || [];
      container.innerHTML = items.map(item => `
        <div class="expense-item ${item.paid ? 'paid' : ''}">
          <div class="expense-item-left">
            <div class="expense-checkbox ${item.paid ? 'checked' : ''}" data-id="${item.id}">
              ${item.paid ? '<svg viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>' : ''}
            </div>
            <button class="delete-btn" data-id="${item.id}" data-type="expense">
              <svg viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
            <span class="expense-item-name">${item.name}</span>
          </div>
          <input type="number" inputmode="decimal" class="expense-input" data-id="${item.id}" value="${item.amount || ''}" placeholder="0.00">
        </div>
      `).join('');

      container.querySelectorAll('.expense-input').forEach(input => {
        input.oninput = (e) => {
          const id = parseInt(e.target.dataset.id);
          const item = data.monthlyExpenses[selectedMonth].items.find(i => i.id === id);
          if (item) {
            item.amount = parseFloat(e.target.value) || 0;
            saveData();
            updateMonthlyTotal();
            renderMonthList();
          }
        };
      });

      container.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = () => {
          const id = parseInt(btn.dataset.id);
          const item = data.monthlyExpenses[selectedMonth].items.find(i => i.id === id);
          if (item) {
            deleteTarget = { type: 'expense', id, name: item.name };
            document.getElementById('deleteText').textContent = `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${item.name}" ?`;
            document.getElementById('deleteModal').classList.remove('hidden');
          }
        };
      });

      container.querySelectorAll('.expense-checkbox').forEach(box => {
        box.onclick = () => {
          const id = parseInt(box.dataset.id);
          const item = data.monthlyExpenses[selectedMonth].items.find(i => i.id === id);
          if (item) {
            item.paid = !item.paid;
            saveData();
            renderExpenseList();
          }
        };
      });
    }

    function updateMonthlyTotal() {
      const total = getMonthTotal(selectedMonth);
      const income = data.monthlyExpenses[selectedMonth]?.income || 0;
      const balance = income - total;

      document.getElementById('monthlyTotal').textContent = '‡∏ø' + formatNumber(total);
      document.getElementById('monthlyIncome').textContent = '‡∏ø' + formatNumber(income);

      const balanceEl = document.getElementById('monthlyBalance');
      balanceEl.textContent = '‡∏ø' + formatNumber(balance);
      balanceEl.className = 'balance-value ' + (balance >= 0 ? 'positive' : 'negative');

      // document.getElementById('currentMonthName').textContent = MONTHS[selectedMonth]; // Removed as it's not in new UI
    }

    function renderMonthlyTab() {
      renderMonthList();
      renderExpenseList();
      updateMonthlyTotal();
      renderDonutChart();
    }

    function renderDonutChart() {
      const items = data.monthlyExpenses[selectedMonth]?.items || [];
      const total = items.reduce((sum, item) => sum + (item.amount || 0), 0);

      // Group by category
      const catTotals = {};
      items.forEach(item => {
        const cat = item.category || 'other';
        catTotals[cat] = (catTotals[cat] || 0) + (item.amount || 0);
      });

      // Generate Chart HTML
      const size = 160;
      const stroke = 20;
      const radius = (size - stroke) / 2;
      const circumference = 2 * Math.PI * radius;
      let offset = 0;

      const segments = Object.entries(catTotals).map(([cat, amount]) => {
        if (amount === 0) return '';
        const percent = total > 0 ? amount / total : 0;
        const dashArray = `${percent * circumference} ${circumference}`;
        const color = CATEGORIES[cat]?.color || CATEGORIES['other'].color;
        const seg = `<circle class="donut-segment" cx="${size / 2}" cy="${size / 2}" r="${radius}" stroke="${color}" stroke-dasharray="${dashArray}" stroke-dashoffset="-${offset}"></circle>`;
        offset += percent * circumference;
        return seg;
      }).join('');

      const legendHtml = Object.entries(catTotals).map(([cat, amount]) => {
        if (amount === 0) return '';
        const info = CATEGORIES[cat] || CATEGORIES['other'];
        return `
          <div class="legend-item">
            <div class="legend-color" style="background: ${info.color}"></div>
            <span>${info.name} (${((amount / total) * 100).toFixed(0)}%)</span>
          </div>
        `;
      }).join('');

      // Insert Chart after Summary
      const summaryDiv = document.querySelector('.balance-card');
      let chartContainer = document.getElementById('monthlyChart');
      if (!chartContainer) {
        chartContainer = document.createElement('div');
        chartContainer.id = 'monthlyChart';
        summaryDiv.after(chartContainer);
      }

      if (total > 0) {
        chartContainer.innerHTML = `
          <div class="chart-container">
            <svg width="${size}" height="${size}" class="donut-chart">
              ${segments}
            </svg>
            <div class="chart-center-text">
              <div class="chart-label">‡∏£‡∏ß‡∏°</div>
              <div class="chart-total">${(total / 1000).toFixed(1)}k</div>
            </div>
          </div>
          <div class="chart-legend">${legendHtml}</div>
        `;
      } else {
        chartContainer.innerHTML = '';
      }
    }

    function renderInstallmentsTab() {
      const container = document.getElementById('installmentsTab');
      container.innerHTML = data.installments.map(inst => {
        const paidCount = inst.payments.filter(p => p.paid).length;
        const totalCount = inst.payments.length;
        return `
          <div class="installment-section">
            <div class="installment-header">
              <div class="installment-info">
                <h3 class="installment-title">${inst.name}</h3>
                <p class="installment-subtitle">‡∏ø${formatNumber(inst.monthlyAmount)}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
              </div>
              <div class="installment-right">
                <div class="progress-box">
                  <span class="progress-text">${paidCount}/${totalCount}</span>
                  <p class="progress-label">‡∏á‡∏ß‡∏î</p>
                </div>
                <button class="delete-btn" data-id="${inst.id}" data-type="installment">
                  <svg viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
              </div>
            </div>
            ${inst.payments.map((p, idx) => `
              <div class="check-item ${p.paid ? 'checked' : ''}" data-inst="${inst.id}" data-idx="${idx}">
                <div class="check-item-left">
                  <div class="checkbox ${p.paid ? 'checked' : ''}">${p.paid ? '<svg viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>' : ''}</div>
                  <span class="check-item-text">${p.month} (${idx + 1}/${totalCount})</span>
                </div>
                <span class="check-item-amount">‡∏ø${formatNumber(inst.monthlyAmount)}</span>
              </div>
            `).join('')}
          </div>
        `;
      }).join('') + `
        <button class="add-item-btn" id="addInstallmentBtn">
          <svg viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
          ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô
        </button>
      `;

      container.querySelectorAll('.check-item').forEach(item => {
        item.onclick = () => {
          const instId = item.dataset.inst;
          const idx = parseInt(item.dataset.idx);
          const inst = data.installments.find(i => i.id === instId);
          if (inst) {
            inst.payments[idx].paid = !inst.payments[idx].paid;
            saveData();
            renderInstallmentsTab();
          }
        };
      });

      container.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          const inst = data.installments.find(i => i.id === id);
          if (inst) {
            deleteTarget = { type: 'installment', id, name: inst.name };
            document.getElementById('deleteText').textContent = `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${inst.name}" ?`;
            document.getElementById('deleteModal').classList.remove('hidden');
          }
        };
      });

      document.getElementById('addInstallmentBtn')?.addEventListener('click', () => showAddModal('installment'));
    }

    function renderTripTab() {
      const container = document.getElementById('tripTab');
      if (!data.trips) data.trips = [];

      container.innerHTML = data.trips.map(trip => {
        const total = trip.items.reduce((sum, item) => sum + (item.amount || 0), 0);
        const budget = trip.budget || 0;
        let progressHtml = '';

        if (budget > 0) {
          const percent = Math.min((total / budget) * 100, 100);
          let barClass = '';
          if (percent > 80) barClass = 'danger';
          else if (percent > 50) barClass = 'warning';

          progressHtml = `
            <div class="budget-info">
              <span>‡πÉ‡∏ä‡πâ‡πÑ‡∏õ ${percent.toFixed(1)}%</span>
              <span>‡∏á‡∏ö ‡∏ø${formatNumber(budget)}</span>
            </div>
            <div class="budget-bar-container">
              <div class="budget-bar-fill ${barClass}" style="width: ${percent}%"></div>
            </div>
          `;
        }

        return `
          <div class="card-section" data-trip="${trip.id}">
            <div class="card-header">
              <div class="card-header-left">
                <h3 class="card-title">${trip.name} (${trip.date})</h3>
                ${progressHtml}
              </div>
              <button class="delete-btn" data-id="${trip.id}" data-type="trip">
                <svg viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
              </button>
            </div>
            ${trip.items.map(item => `
              <div class="card-row">
                <div class="card-row-left">
                  <span class="card-row-name">${item.name}</span>
                  ${item.note ? `<span class="card-row-note">${item.note}</span>` : ''}
                </div>
                <div class="card-row-right">
                  <input type="number" inputmode="decimal" class="card-input" data-trip="${trip.id}" data-item="${item.id}" value="${item.amount || ''}" placeholder="0">
                  <button class="delete-btn small" data-trip="${trip.id}" data-item="${item.id}" data-type="trip-item">
                    <svg viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
                  </button>
                </div>
              </div>
            `).join('')}
            <div class="card-total">
              <span class="card-total-label">‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</span>
              <span class="card-total-amount">‡∏ø${formatNumber(total)}</span>
            </div>
            <button class="add-item-btn small" data-trip="${trip.id}">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ó‡∏£‡∏¥‡∏õ‡∏ô‡∏µ‡πâ</button>
          </div>
        `;
      }).join('') + `
        <button class="add-item-btn" id="addTripBtn">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà</button>
      `;

      // Event listeners
      container.querySelectorAll('.card-input').forEach(input => {
        input.oninput = (e) => {
          const tripId = e.target.dataset.trip;
          const itemId = parseInt(e.target.dataset.item);
          const trip = data.trips.find(t => t.id === tripId);
          if (trip) {
            const item = trip.items.find(i => i.id === itemId);
            if (item) {
              item.amount = parseFloat(e.target.value) || 0;
              saveData();
              renderTripTab();
            }
          }
        };
      });

      container.querySelectorAll('.delete-btn[data-type="trip"]').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          const trip = data.trips.find(t => t.id === id);
          if (trip) {
            deleteTarget = { type: 'trip', id, name: trip.name };
            document.getElementById('deleteText').textContent = `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${trip.name}" ?`;
            document.getElementById('deleteModal').classList.remove('hidden');
          }
        };
      });

      container.querySelectorAll('.delete-btn[data-type="trip-item"]').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          const tripId = btn.dataset.trip;
          const itemId = parseInt(btn.dataset.item);
          const trip = data.trips.find(t => t.id === tripId);
          if (trip) {
            const item = trip.items.find(i => i.id === itemId);
            if (item) {
              deleteTarget = { type: 'trip-item', tripId, itemId, name: item.name };
              document.getElementById('deleteText').textContent = `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${item.name}" ?`;
              document.getElementById('deleteModal').classList.remove('hidden');
            }
          }
        };
      });

      container.querySelectorAll('.add-item-btn.small').forEach(btn => {
        btn.onclick = () => showAddModal('trip-item', btn.dataset.trip);
      });

      document.getElementById('addTripBtn')?.addEventListener('click', () => showAddModal('trip'));
    }

    function renderCardsTab() {
      const container = document.getElementById('cardsTab');
      if (!data.cards) data.cards = [];

      container.innerHTML = data.cards.map(card => {
        const total = card.items.reduce((sum, item) => sum + (item.amount || 0), 0);
        return `
          <div class="card-section" data-card="${card.id}">
            <div class="card-header">
              <div class="card-header-left">
                <h3 class="card-title">${card.name}</h3>
                <span class="card-subtitle">‡∏¢‡∏≠‡∏î‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${card.month}</span>
              </div>
              <div class="card-header-right">
                <span class="card-header-total">‡∏ø${formatNumber(total)}</span>
                <button class="delete-btn" data-id="${card.id}" data-type="card">
                  <svg viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
              </div>
            </div>
            ${card.items.map(item => `
              <div class="card-row">
                <div class="card-row-left">
                  ${item.date ? `<span class="card-row-date"><span class="date-label">${item.monthIdx !== undefined ? MONTHS[item.monthIdx] : card.month}</span><span class="date-num">${item.date}</span></span>` : '<span class="card-row-date empty"></span>'}
                  <span class="card-row-name">${item.name}</span>
                </div>
                <div class="card-row-right">
                  <input type="number" inputmode="decimal" class="card-input" data-card="${card.id}" data-item="${item.id}" value="${item.amount || ''}" placeholder="0">
                  <button class="delete-btn small" data-card="${card.id}" data-item="${item.id}" data-type="card-item">
                    <svg viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
                  </button>
                </div>
              </div>
            `).join('')}
            <button class="add-item-btn small" data-card="${card.id}">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô ${card.name}</button>
          </div>
        `;
      }).join('') + `
        <button class="add-item-btn" id="addCardBtn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏ö‡πÉ‡∏´‡∏°‡πà</button>
      `;

      // Event listeners
      container.querySelectorAll('.card-input').forEach(input => {
        input.oninput = (e) => {
          const cardId = e.target.dataset.card;
          const itemId = parseInt(e.target.dataset.item);
          const card = data.cards.find(c => c.id === cardId);
          if (card) {
            const item = card.items.find(i => i.id === itemId);
            if (item) {
              item.amount = parseFloat(e.target.value) || 0;
              saveData();
              renderCardsTab();
            }
          }
        };
      });

      container.querySelectorAll('.delete-btn[data-type="card"]').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          const card = data.cards.find(c => c.id === id);
          if (card) {
            deleteTarget = { type: 'card', id, name: card.name };
            document.getElementById('deleteText').textContent = `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${card.name}" ?`;
            document.getElementById('deleteModal').classList.remove('hidden');
          }
        };
      });

      container.querySelectorAll('.delete-btn[data-type="card-item"]').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          const cardId = btn.dataset.card;
          const itemId = parseInt(btn.dataset.item);
          const card = data.cards.find(c => c.id === cardId);
          if (card) {
            const item = card.items.find(i => i.id === itemId);
            if (item) {
              deleteTarget = { type: 'card-item', cardId, itemId, name: item.name };
              document.getElementById('deleteText').textContent = `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${item.name}" ?`;
              document.getElementById('deleteModal').classList.remove('hidden');
            }
          }
        };
      });

      container.querySelectorAll('.add-item-btn.small').forEach(btn => {
        btn.onclick = () => showAddModal('card-item', btn.dataset.card);
      });

      document.getElementById('addCardBtn')?.addEventListener('click', () => showAddModal('card'));
    }

    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.nav-btn').forEach(btn => {
        const isActive = btn.dataset.tab === tab;
        btn.classList.toggle('active', isActive);
        const indicator = btn.querySelector('.nav-indicator');
        if (isActive && !indicator) {
          btn.insertAdjacentHTML('beforeend', '<div class="nav-indicator"></div>');
        } else if (!isActive && indicator) {
          indicator.remove();
        }
      });

      document.getElementById('monthlyTab').classList.toggle('hidden', tab !== 'monthly');
      document.getElementById('installmentsTab').classList.toggle('hidden', tab !== 'installments');
      document.getElementById('tripTab').classList.toggle('hidden', tab !== 'trip');
      document.getElementById('cardsTab').classList.toggle('hidden', tab !== 'cards');

      if (tab === 'monthly') renderMonthlyTab();
      else if (tab === 'installments') renderInstallmentsTab();
      else if (tab === 'trip') renderTripTab();
      else if (tab === 'cards') renderCardsTab();
    }

    // Modal functions
    function showAddModal(type, parentId) {
      const modal = document.getElementById('addModal');
      const title = document.getElementById('modalTitle');
      const content = document.getElementById('modalContent');

      if (!type) {
        title.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà';
        content.innerHTML = `
          <div class="modal-grid">
            <button class="modal-option" data-add="monthly">
              <div class="modal-option-icon">üìä</div>
              <div class="modal-option-text">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
            </button>
            <button class="modal-option" data-add="installment">
              <div class="modal-option-icon">üìÖ</div>
              <div class="modal-option-text">‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≠‡∏ô</div>
            </button>
          </div>
        `;
        content.querySelectorAll('.modal-option').forEach(btn => {
          btn.onclick = () => showAddModal(btn.dataset.add);
        });
      } else if (type === 'monthly') {
        title.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
        content.innerHTML = `
          <div class="form-group">
            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
            <input type="text" class="form-input" id="newItemName" placeholder="‡πÄ‡∏ä‡πà‡∏ô Netflix, Youtube...">
          </div>
          <div class="form-group">
            <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
            <input type="number" inputmode="decimal" class="form-input" id="newItemAmount" placeholder="0.00">
          </div>
          <div class="form-group">
            <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
            <select class="form-input" id="newItemCategory">
              <option value="food">‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
              <option value="travel">‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</option>
              <option value="shopping">‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á</option>
              <option value="bills">‡∏ö‡∏¥‡∏•/‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ</option>
              <option value="other" selected>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
            </select>
          </div>
          <p class="form-hint">‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô ${MONTHS[selectedMonth]}</p>
          <button class="form-submit" id="submitNewItem">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        `;

        document.getElementById('submitNewItem').onclick = async () => {
          const btn = document.getElementById('submitNewItem');
          const originalText = btn.textContent;
          btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
          btn.disabled = true;

          const name = document.getElementById('newItemName').value.trim();
          const amount = parseFloat(document.getElementById('newItemAmount').value) || 0;
          const category = document.getElementById('newItemCategory').value;

          if (name) {
            data.monthlyExpenses[selectedMonth].items.push({ id: Date.now(), name, amount, category, paid: false });
            if (saveData()) {
              closeModal();
              renderMonthlyTab();
            } else {
              // If save failed, remove the item we just pushed (rollback)
              data.monthlyExpenses[selectedMonth].items.pop();
            }
          }

          btn.textContent = originalText;
          btn.textContent = originalText;
          btn.disabled = false;
        };
      } else if (type === 'installment') {
        title.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô';
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();

        // Generate Year Options (Current - 1 to + 5)
        let yearOptions = '';
        for (let i = -1; i <= 5; i++) {
          const y = currentYear + i;
          const be = y + 543;
          yearOptions += `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${be}</option>`;
        }

        // Generate Month Options
        let monthOptions = '';
        MONTHS.forEach((m, i) => {
          monthOptions += `<option value="${i}" ${i === currentMonth ? 'selected' : ''}>${m}</option>`;
        });

        content.innerHTML = `
          <div class="form-group">
            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
            <input type="text" class="form-input" id="newInstName" placeholder="‡πÄ‡∏ä‡πà‡∏ô iPhone 15, ‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô...">
          </div>
          <div class="form-group">
            <label class="form-label">‡∏¢‡∏≠‡∏î‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
            <input type="number" inputmode="decimal" class="form-input" id="newInstAmount" placeholder="0.00">
          </div>
          <div class="form-group">
            <label class="form-label">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ú‡πà‡∏≠‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÑ‡∏´‡∏ô</label>
            <div style="display: flex; gap: 8px;">
              <select class="form-input" id="newInstStartMonthSelect" style="flex: 2;">
                ${monthOptions}
              </select>
              <select class="form-input" id="newInstStartYearSelect" style="flex: 1;">
                ${yearOptions}
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î</label>
            <select class="form-input" id="newInstMonths">
              <option value="3">3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
              <option value="6">6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
              <option value="10" selected>10 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
              <option value="12">12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
              <option value="24">24 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
              <option value="36">36 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
              <option value="48">48 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
            </select>
          </div>
          <button class="form-submit" id="submitNewInst">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô</button>
        `;
        document.getElementById('submitNewInst').onclick = () => {
          const name = document.getElementById('newInstName').value.trim();
          const amount = parseFloat(document.getElementById('newInstAmount').value) || 0;
          const months = parseInt(document.getElementById('newInstMonths').value);
          const startMonth = parseInt(document.getElementById('newInstStartMonthSelect').value);
          const startYear = parseInt(document.getElementById('newInstStartYearSelect').value);

          if (name && amount) {
            const payments = [];

            // Create date object for calculation
            let currentDate = new Date(startYear, startMonth, 1);

            for (let i = 0; i < months; i++) {
              const mIndex = currentDate.getMonth();
              const y = currentDate.getFullYear() + 543; // Convert to BE
              const yStr = y.toString().slice(-2);
              const monthStr = `${MONTHS[mIndex]} ${yStr}`;

              payments.push({ month: monthStr, paid: false });

              // Increment month
              currentDate.setMonth(currentDate.getMonth() + 1);
            }

            data.installments.push({ id: 'inst-' + Date.now(), name, monthlyAmount: amount, payments });
            saveData();
            closeModal();
            renderInstallmentsTab();
          }
        };
      } else if (type === 'trip') {
        title.textContent = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà';
        content.innerHTML = `
          <div class="form-group">
            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏£‡∏¥‡∏õ</label>
            <input type="text" class="form-input" id="newTripName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏£‡∏¥‡∏õ‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô, ‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ...">
          </div>
          <div class="form-group">
            <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏£‡∏¥‡∏õ</label>
            <input type="date" class="form-input" id="newTripDate">
          </div>
          <div class="form-group">
            <label class="form-label">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (‡∏ö‡∏≤‡∏ó)</label>
            <input type="number" inputmode="decimal" class="form-input" id="newTripBudget" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">
          </div>
          <button class="form-submit" id="submitNewTrip">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏£‡∏¥‡∏õ</button>
        `;
        document.getElementById('submitNewTrip').onclick = () => {
          const name = document.getElementById('newTripName').value.trim();
          const dateStr = document.getElementById('newTripDate').value;
          const budget = parseFloat(document.getElementById('newTripBudget').value) || 0;
          if (name && dateStr) {
            const formattedDate = formatThaiDate(dateStr);
            data.trips.push({ id: 'trip-' + Date.now(), name, date: formattedDate, budget, items: [] });
            saveData();
            closeModal();
            renderTripTab();
          }
        };

      } else if (type === 'trip-item') {
        title.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ó‡∏£‡∏¥‡∏õ';
        content.innerHTML = `
          <div class="form-group">
            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
            <input type="text" class="form-input" id="newTripItemName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏±‡πã‡∏ß‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏¥‡∏ô, ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å...">
          </div>
          <div class="form-group">
            <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
            <input type="number" inputmode="decimal" class="form-input" id="newTripItemAmount" placeholder="0.00">
          </div>
          <div class="form-group">
            <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
            <input type="text" class="form-input" id="newTripItemNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ã‡∏∑‡πâ‡∏≠">
          </div>
          <button class="form-submit" id="submitNewTripItem">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        `;
        document.getElementById('submitNewTripItem').onclick = () => {
          const name = document.getElementById('newTripItemName').value.trim();
          const amount = parseFloat(document.getElementById('newTripItemAmount').value) || 0;
          const note = document.getElementById('newTripItemNote').value.trim();
          if (name) {
            const trip = data.trips.find(t => t.id === parentId);
            if (trip) {
              trip.items.push({ id: Date.now(), name, amount, note: note || null });
              saveData();
              closeModal();
              renderTripTab();
            }
          }
        };
      } else if (type === 'card') {
        title.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏ö‡πÉ‡∏´‡∏°‡πà';
        content.innerHTML = `
          <div class="form-group">
            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ï‡∏£</label>
            <input type="text" class="form-input" id="newCardName" placeholder="‡πÄ‡∏ä‡πà‡∏ô KBANK, SCB, KTC...">
          </div>
          <div class="form-group">
            <label class="form-label">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢</label>
            <select class="form-input" id="newCardMonth">
              ${MONTHS.map((m, i) => `<option value="${m}" ${i === new Date().getMonth() ? 'selected' : ''}>${m}</option>`).join('')}
            </select>
          </div>
          <button class="form-submit" id="submitNewCard">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£</button>
        `;
        document.getElementById('submitNewCard').onclick = () => {
          const name = document.getElementById('newCardName').value.trim();
          const month = document.getElementById('newCardMonth').value;
          if (name) {
            if (!data.cards) data.cards = [];
            data.cards.push({ id: 'card-' + Date.now(), name, month, items: [] });
            saveData();
            closeModal();
            renderCardsTab();
          }
        };
      } else if (type === 'card-item') {
        const today = new Date();
        const dateStr = today.toISOString().split('T')[0];
        title.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ö‡∏±‡∏ï‡∏£';
        content.innerHTML = `
          <div class="form-group">
            <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" class="form-input" id="newCardItemDate" value="${dateStr}">
          </div>
          <div class="form-group">
            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
            <input type="text" class="form-input" id="newCardItemName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ô‡πá‡∏ï, ‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≤‡∏ß">
            <div class="quick-tags" id="quickTags">
              <button type="button" class="quick-tag" data-name="7-Eleven">7-Eleven</button>
              <button type="button" class="quick-tag" data-name="Grab">Grab</button>
              <button type="button" class="quick-tag" data-name="Top 100">Top 100</button>
              <button type="button" class="quick-tag" data-name="Lotus's">Lotus's</button>
              <button type="button" class="quick-tag" data-name="Shopee">Shopee</button>
              <button type="button" class="quick-tag" data-name="Lazada">Lazada</button>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
            <div class="form-input-with-icon">
              <span class="form-input-icon">‡∏ø</span>
              <input type="number" inputmode="decimal" class="form-input" id="newCardItemAmount" placeholder="0.00" style="padding-left: 36px;">
            </div>
          </div>
          <button class="form-submit" id="submitNewCardItem">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        `;

        // Quick tags click
        document.querySelectorAll('.quick-tag').forEach(tag => {
          tag.onclick = () => {
            document.querySelectorAll('.quick-tag').forEach(t => t.classList.remove('selected'));
            tag.classList.add('selected');
            document.getElementById('newCardItemName').value = tag.dataset.name;
          };
        });

        document.getElementById('submitNewCardItem').onclick = () => {
          const name = document.getElementById('newCardItemName').value.trim();
          const amount = parseFloat(document.getElementById('newCardItemAmount').value) || 0;
          const dateVal = document.getElementById('newCardItemDate').value;
          const dateObj = dateVal ? new Date(dateVal) : null;
          const day = dateObj ? dateObj.getDate() : null;
          const monthIdx = dateObj ? dateObj.getMonth() : null;
          if (name) {
            const card = data.cards.find(c => c.id === parentId);
            if (card) {
              card.items.push({ id: Date.now(), name, amount, date: day, monthIdx });
              saveData();
              closeModal();
              renderCardsTab();
            }
          }
        };
      } else if (type === 'salary') {
        title.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö';
        const currentIncome = data.monthlyExpenses[selectedMonth]?.income || 0;
        content.innerHTML = `
          <div class="form-group">
            <label class="form-label">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (‡∏ö‡∏≤‡∏ó)</label>
            <input type="number" inputmode="decimal" class="form-input" id="newSalaryAmount" value="${currentIncome}" placeholder="0.00">
          </div>
          <button class="form-submit" id="submitSalary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        `;

        // Focus input
        setTimeout(() => document.getElementById('newSalaryAmount').focus(), 100);

        document.getElementById('submitSalary').onclick = () => {
          const amount = parseFloat(document.getElementById('newSalaryAmount').value) || 0;
          if (!data.monthlyExpenses[selectedMonth]) {
            data.monthlyExpenses[selectedMonth] = { items: [], income: 0 };
          }
          data.monthlyExpenses[selectedMonth].income = amount;
          saveData();
          updateMonthlyTotal();
          renderDonutChart();
          closeModal();
        };
      }

      modal.classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('addModal').classList.add('hidden');
    }

    // Event listeners
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.onclick = () => switchTab(btn.dataset.tab);
    });

    document.getElementById('headerAddBtn').onclick = () => showAddModal(null);
    document.getElementById('addExpenseBtn').onclick = () => showAddModal('monthly');
    document.getElementById('editSalaryBtn').onclick = () => showAddModal('salary');
    document.getElementById('closeModal').onclick = closeModal;
    document.getElementById('addModal').onclick = (e) => {
      if (e.target.id === 'addModal') closeModal();
    };

    document.getElementById('cancelDelete').onclick = () => {
      document.getElementById('deleteModal').classList.add('hidden');
      deleteTarget = null;
    };

    document.getElementById('confirmDelete').onclick = () => {
      if (deleteTarget) {
        if (deleteTarget.type === 'expense') {
          data.monthlyExpenses[selectedMonth].items = data.monthlyExpenses[selectedMonth].items.filter(i => i.id !== deleteTarget.id);
          saveData();
          renderMonthlyTab();
        } else if (deleteTarget.type === 'installment') {
          data.installments = data.installments.filter(i => i.id !== deleteTarget.id);
          saveData();
          renderInstallmentsTab();
        } else if (deleteTarget.type === 'trip') {
          data.trips = data.trips.filter(t => t.id !== deleteTarget.id);
          saveData();
          renderTripTab();
        } else if (deleteTarget.type === 'trip-item') {
          const trip = data.trips.find(t => t.id === deleteTarget.tripId);
          if (trip) {
            trip.items = trip.items.filter(i => i.id !== deleteTarget.itemId);
            saveData();
            renderTripTab();
          }
        } else if (deleteTarget.type === 'card') {
          data.cards = data.cards.filter(c => c.id !== deleteTarget.id);
          saveData();
          renderCardsTab();
        } else if (deleteTarget.type === 'card-item') {
          const card = data.cards.find(c => c.id === deleteTarget.cardId);
          if (card) {
            card.items = card.items.filter(i => i.id !== deleteTarget.itemId);
            saveData();
            renderCardsTab();
          }
        }
      }
      document.getElementById('deleteModal').classList.add('hidden');
      deleteTarget = null;
    };

    // Init
    renderMonthlyTab();
  </script>
</body>

</html>
